{% extends 'base.html.twig' %}

{% block title %}Bilan des Susars{% endblock %}

{% block body %}
<div class="container py-3">
    <h1 class="h3 mb-3 text-center">Bilan des SUSARs</h1>

    <form method="get" class="row g-2 align-items-end mb-4 justify-content-center text-center">
        <div class="col-auto">
            <label class="form-label mb-1">Date début</label>
            <input type="date" name="start" value="{{ filters.start }}" class="form-control form-control-sm" />
        </div>
        <div class="col-auto">
            <label class="form-label mb-1">Date fin</label>
            <input type="date" name="end" value="{{ filters.end }}" class="form-control form-control-sm" />
        </div>
        <div class="col-auto">
            <button class="btn btn-sm btn-primary">Actualiser</button>
        </div>
    </form>

	{% for block in charts %}
		<section id="section-{{ block.id }}" class="mb-5">
			<div class="row justify-content-center">
                <div class="col-12 col-md-11 col-lg-9">
                    <div class="card shadow-sm border border-secondary-subtle">
                        <div class="card-header text-center">
                            <h2 class="h5 m-0">{{ block.title }}</h2>
						</div>
						<div class="card-body">
							<div class="chart-box" style="height: 320px;">
								{{ render_chart(block.chart_counts, {'data-controller': 'stacked-bar-chart'}) }}
							</div>
							<div class="chart-box mt-3" style="height: 320px;">
								{{ render_chart(block.chart_percent, {'data-controller': 'stacked-bar-chart'}) }}
							</div>

							<div class="mt-3">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<h3 class="h6 m-0">Tableau (effectifs)</h3>
									<button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyTableToClipboard(this)">Copier</button>
								</div>
								<div class="table-responsive">
									<table class="table table-sm table-bordered align-middle">
										<thead>
											<tr>
												{% for h in block.table_counts.headers %}
													<th>{{ h }}</th>
												{% endfor %}
											</tr>
										</thead>
										<tbody>
											{% for row in block.table_counts.rows %}
												<tr>
													{% for c in row %}
														<td>{{ c }}</td>
													{% endfor %}
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>

							<div class="mt-3">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<h3 class="h6 m-0">Tableau (%)</h3>
									<button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyTableToClipboard(this)">Copier</button>
								</div>
								<div class="table-responsive">
									<table class="table table-sm table-bordered align-middle">
										<thead>
											<tr>
												{% for h in block.table_counts.headers %}
													<th>{{ h }}</th>
												{% endfor %}
											</tr>
										</thead>
										<tbody>
											{% for row in block.table_percent.rows %}
												<tr>
													{% for c in row %}
														<td>{{ c }}</td>
													{% endfor %}
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</section>
	{% endfor %}
</div>

<script>
// Delegate clicks for toggle buttons (robust in all browsers)
document.addEventListener('click', function(e) {
	var target = e.target;
	if (!(target instanceof Element)) return;
	var btn = target.closest('button[data-mode][data-section-id]');
	if (!btn) return;
	var mode = btn.getAttribute('data-mode');
	var sectionId = btn.getAttribute('data-section-id');
	toggleChartMode(btn, mode, sectionId);
});

// Toggle between counts and percentage for a chart inside the same section
function toggleChartMode(button, mode, sectionId) {
	const group = button.closest('.btn-group');
	if (!group) return;
	group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
	button.classList.add('active');

	const section = sectionId ? document.getElementById(sectionId) : group.closest('section');
	const wrappers = section.querySelectorAll('.chart-pane[data-chart-mode]');
	wrappers.forEach(w => {
		const isTarget = w.getAttribute('data-chart-mode') === mode;
		w.classList.toggle('is-hidden', !isTarget);
		w.setAttribute('aria-hidden', isTarget ? 'false' : 'true');
	});
	section.setAttribute('data-view', mode);

	// No need to touch Chart instances: both canvases are rendered server-side
}

<style>
.chart-pane { opacity: 1; visibility: visible; pointer-events: auto; }
.chart-pane.is-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
[data-view="counts"] .chart-pane[data-chart-mode="percent"] { display: none !important; }
[data-view="percent"] .chart-pane[data-chart-mode="counts"] { display: none !important; }
</style>

function copyTableToClipboard(button) {
	// Find the table within the same container as the button
	const table = button.closest('.mt-3').querySelector('table');
	if (!table) return;
	const rows = Array.from(table.querySelectorAll('tr'));
	const lines = rows.map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => sanitizeCell(td.innerText)).join('\t')).join('\n');
	navigator.clipboard.writeText(lines).then(() => {
		button.textContent = 'Copié !';
		setTimeout(() => button.textContent = 'Copier', 1500);
	});
}
function sanitizeCell(text) {
	return (text || '').replaceAll('\n', ' ').replaceAll('\t', ' ').trim();
}
</script>
{% endblock %}
